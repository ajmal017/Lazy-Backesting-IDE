
<!DOCTYPE html>

<html>
<!--
    (c)2015 John Orford
    
    This file is part of Lazy Backtesting.

    Lazy Backtesting is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Lazy Backtesting is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with Lazy Backtesting.  If not, see <http://www.gnu.org/licenses/>.
        //
-->
<head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  
        <title>Lazy Backtest IDE</title>
        
        <script type="text/javascript" src="lib/lazy.js"></script>
        <script type="text/javascript" src="lib/jstat.min.js"></script>
        <script type="text/javascript" src="lib/networking2.js"></script>
        <script type="text/javascript" src="lib/utility.js"></script>
        <script type="text/javascript" src="lib/strategyHelpers.js"></script>
        <script type="text/javascript" src="lib/d3.min.js"></script>
       
        
        <script type="text/javascript" charset="utf-8" src="lib/numeric-1.2.6.min.js"></script>
       
        <script src="lib/codemirror.js"></script>
        <link rel="stylesheet" href="lib/codemirror.css">
        <script src="lib/javascript.js"></script>
        
        <style>
                #title{font-size:6em}
                #downloadResults{display:none;}
        </style>
        
</head>

<body>
        <iframe name="my_iframe" src="about:blank" style="display:none;"></iframe>

        <form autocomplete="on" target="my_iframe" action="about:blank" method='get'>

                <button id="submitButton" type="submit" style="display:none;"></button>

                <div id="title">Lazy Backtest IDE</div>

                <hr />  
                <p>1) Set the strategy's holding period</p>
                
                <div>   
                        <select id='horizon'>
                                <option value='1'>Daily</option>
                                <option value='5'>Weekly</option>
                                <option value='21' selected="selected">Monthly</option>
                                <option value='63'>Quarterly</option>
                        </select>
                </div>

                <hr />
                
                <p>2) Pull required data down from <a href='https://www.quandl.com/'>Quandl</a> by specifying sources and tickers</p>

                
                <div>
                        <select id='source2' autocomplete="on">
                                <option value='GOOG'>Google</option>
                                <option value='YAHOO'>Yahoo</option>
                                <option value='SPDJ'>S&amp;P Dow Jones</option>
                                <option value='CBOE' selected="selected">Chicago Board of Options Exchange</option>
                        </select>
                        <input type="text" id='ticker2' value='SKEW'/>
                        Yield
                        <input type="checkbox" id="yield2" value="true" autocomplete="on"/>
                        <a href='javascript:void(0)' id='addAsset2'>Add</a>
                </div>

                <div>
                        <select id='source1' autocomplete="on">
                                <option value='GOOG'>Google</option>
                                <option value='YAHOO' selected="selected">Yahoo</option>

                                <option value='SPDJ'>S&amp;P Dow Jones</option>
                                <option value='CBOE'>Chicago Board of Options Exchange</option>
                        </select>
                        <input type="text" id='ticker1' value='INDEX_GSPC' value="true" autocomplete="on"/>
                        Yield
                        <input type="checkbox" id="yield1" autocomplete="on"/>
                        <a href='javascript:void(0)' id='addAsset1'>Add</a>
                </div>
                
                <div>
                        <select id='source3' autocomplete="on">
                                <option value='GOOG'>Google</option>
                                <option value='YAHOO' selected="selected">Yahoo</option>
                                <option value='SPDJ'>S&amp;P Dow Jones</option>
                                <option value='CBOE'>Chicago Board of Options Exchange</option>
                        </select>
                        <input type="text" id='ticker3' value='INDEX_IRX' value="true" autocomplete="on"/>
                        Yield
                        <input type="checkbox" id="yield3" autocomplete="on" checked />
                        <a href='javascript:void(0)' id='addAsset3'>Add</a>
                </div>
                
                <hr />  
                
                <div id="availableData"></div>
                
                        

                <hr />
                
                <p>3) Code your strategy in the browser</p>

                <div id="code"></div>
                
                <hr /> 
                
                <p>4) Hit the back test link</p>
                
                <p><a href='javascript:void(0)' id="BackTest">Back Test</a></p>
                
                
                <div id="messages"></div>
                
                
                <a id='downloadResults'>Download CSV file</a>
                
                <hr />

                <p>Optional: input a Quandl key for unlimited & free data</p>
                <div>                
                        <input type="password" id='key' autocomplete="on"/>
                </div>
                
                <hr />

                <p><a href='http://blog.johnorford.com/2015/04/29/lazy-backtesting-update/'>API Details</a></p>

                <p>Need help? Watch the screencast:</p>
                
                <!--
                <iframe width="960" height="720" src="https://www.youtube-nocookie.com/embed/dWYPNS_mc6U?rel=0" frameborder="0" allowfullscreen></iframe>
                -->
        </form>
</body>

        <script>
                "use strict"

                
                //*****************************************************
                //get data
         
                function getData(source,ticker,y){
                        return getQuandlData(source,ticker)
                                .take(1)
                                .value()[0]
                                .map(
                                        function(i){
                                                var r = null;
                                                y == true ?
                                                        r = {ticker: ticker, date: new Date(i[0]), datum:i[1].yieldToDsft()} 
                                                        :
                                                        r = {ticker: ticker, date: new Date(i[0]), datum:i[1]};
                                                return r;
                                                }
                                        );
                        }

                //*****************************************************
                //add assets
                        
                
                function addAsset(no,dataSoFar){
                        var ticker = document.getElementById('ticker'+no).value;
                        
                        var newData = getData(
                                document.getElementById('source'+no).value,
                                ticker,
                                document.getElementById('yield'+no).checked
                                );
                        
                        //add data to 'addAsset listener'
                        //set listeners function
                        //feed need data into each
                        //append to existing data
                        
                        var data = dataSoFar.concat({ticker: ticker, prices: newData});
                        setListeners(data);
                        
                        //clean
                        console.log( data.cleanData().formatData().toArray() );
                        
                        //format
                        
                        
                        //update 'backtest' link
                        
                        }
        
                
                
                
                //initialise
                setListeners([],[]);
        
                function removeListener(id){
                        var old_element = document.getElementById(id);
                        var new_element = old_element.cloneNode(true);
                        old_element.parentNode.replaceChild(new_element, old_element);
                        }
                        
                function addListener(id,data){
                        document.getElementById('addAsset'+id)
                                .addEventListener(
                                        "click", 
                                        function(){addAsset(id,data);}
                                        );
                        }
                        
                function setListeners(data){
                        removeListener('addAsset1');
                        removeListener('addAsset2');
                        removeListener('addAsset3');
                        
                        addListener(1,data);
                        addListener(2,data);
                        addListener(3,data);
                        }
                
                
                //*****************************************************
                //only run after add asset - horizon doesn't affect this
                //remove mismatching dates
                //return checking (i.e. that returns encompass the required horizon) should be done later
                //parallelable?
                //if run in asynced process as a whole job (not chunks) kill once newer cleandata has been kicked off... only one should run at any time.
                var cleanData = function(){
                        var _this = this;
                        return Lazy(this)
                                .reduce(function(acc,c){return acc.concat(c.prices);},Lazy([]))
                                //ensure dates are matched for every assetall the way down the line
                                .groupBy(function(i){return i.date })
                                //make sure the lengths fo arrays at every date are the same
                                .filter(function(i){return i.length === _this.length;})
                                //bring objects together into one big array
                                .flatten()
                                //.filter(function(i){return i.ticker != undefined;})
                                .groupBy(function(j){return j.ticker})
                                //convert to object -> {ticker:prices,...}
                                .reduce(
                                        function(acc,c){
                                                //console.log(c);
                                                acc[c[0].ticker] = c;
                                                return acc;  
                                                }
                                        , {}
                                        );
                        
                        }
                
                Object.defineProperty(
                        Object.prototype, 
                        'cleanData',
                        {
                                value: cleanData,
                                writable: true,
                                configurable: true,
                                enumerable: false
                                }
                        );  
                
                //*****************************************************
                function clone(obj) {
                    var copy;
                    // Handle the 3 simple types, and null or undefined
                    if (null == obj || "object" != typeof obj) return obj;
                    // Handle Date
                    if (obj instanceof Date) {
                        copy = new Date();
                        copy.setTime(obj.getTime());
                        return copy;
                    }
                    // Handle Array
                    if (obj instanceof Array) {
                        copy = [];
                        for (var i = 0, len = obj.length; i < len; i++) {
                            copy[i] = clone(obj[i]);
                        }
                        return copy;
                    }
                    // Handle Object
                    if (obj instanceof Object) {
                        copy = {};
                        for (var attr in obj) {
                            if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
                        }
                        return copy;
                    }
                    throw new Error("Unable to copy obj! Its type isn't supported.");
                }
                
                //*****************************************************
                
                Object.defineProperty(
                        Object.prototype, 
                        'formatData',
                        {
                                value: function(){
                                        var _this = this;
                                        return Lazy.generate(
                                                function() {
                                                        //update
                                                        return function() {
                                                                var horizon = document.getElementById('horizon').value;
                                                                //convert to future/history object
                                                                var ret = Object
                                                                        .keys(_this)
                                                                        .reduce(
                                                                                function(acc,k){
                                                                                        //horizon +1 of prices in order to get horizon's worth of returns
                                                                                        //generate return
                                                                                        acc.date = _this[k][0].date;
                                                                                        acc.future[k] = [ _this[k][0], _this[k][horizon] ].returns();;
                                                                                        acc.history[k] = _this[k].slice(horizon, _this[k].length );
                                                                                        return acc;
                                                                                        }
                                                                                ,{date:"", future:{}, history:{}}
                                                                                );
                                                                //knock off tops of each time series
                                                                _this = Object
                                                                        .keys(_this)
                                                                        .reduce(
                                                                                function(acc,k){
                                                                                        acc[k] = _this[k].slice(horizon, _this[k].length );
                                                                                        return acc;
                                                                                        }
                                                                                ,{}
                                                                                );
                                                                return ret;
                                                                };
                                                        }()
                                                //number of backtests with current horizon
                                                //horizon worth of return require horizon+1 of prices
                                                , Math.floor((_this[Object.keys(_this)[0]].length-1)/document.getElementById('horizon').value)
                                                );
                                        },
                                writable: true,
                                configurable: true,
                                enumerable: false
                                }
                        );     
        
        
                //*****************************************************
                
        </script>
</html>
